
    <link rel="stylesheet" type="text/css" href="/static/home/css/pages-cart.css" />

	<script type="text/javascript" src="/static/home/js/pages/index.js"></script>

	<!--主内容-->
	<div class="cart py-container">
		<!--All goods-->
		<div class="allgoods">
			<h4>全部商品<span>11</span></h4>
			<div class="cart-main">
				<div class="yui3-g cart-th">
					<div class="yui3-u-1-4"><input type="checkbox" name="" id="" value="" /> 全部</div>
					<div class="yui3-u-1-4">商品</div>
					<div class="yui3-u-1-8">单价（元）</div>
					<div class="yui3-u-1-8">数量</div>
					<div class="yui3-u-1-8">小计（元）</div>
					<div class="yui3-u-1-8">操作</div>
				</div>
				<div class="cart-item-list">
					<div class="cart-shop">
						<input type="checkbox" name="" id="" value="" />
						<span class="shopname self">传智自营</span>
					</div>
					<div class="cart-body">
						{foreach $list as $v}
						<div class="cart-list">
							<ul goods_id="{$v.goods_id}" goods_attr_ids="{$v.goods_attr_ids}" number="{$v.number}" cart_id="{$v.id|default=''}" class="goods-list yui3-g">
								<li class="yui3-u-1-24">
									<input type="checkbox" class="row_check" name="" id="" value="" />
								</li>
								<li class="yui3-u-6-24">
									<div class="good-item">
										<div class="item-img"><img src="{$v.goods.goods_logo}" /></div>
										<div class="item-msg">{$v.goods.goods_name}</div>
									</div>
								</li>
								<li class="yui3-u-5-24">
									<div class="item-txt">
										{foreach $v['goodsattr'] as $attr}
										{$attr.attr_name}：{$attr.attr_value}<br>
										{/foreach}
									</div>
								</li>
								<li class="yui3-u-1-8"><span class="price">{$v.goods.goods_price}</span></li>
								<li class="yui3-u-1-8">
									<a href="javascript:void(0)" class="increment mins">-</a>
									<input autocomplete="off" type="text" value="{$v.number}" minnum="1" class="itxt current_number" />
									<a href="javascript:void(0)" class="increment plus">+</a>
								</li>
								<li class="yui3-u-1-8"><span class="sum">{$v.goods.goods_price * $v.number}</span></li>
								<li class="yui3-u-1-8">
									<a href="javascript:;" class="delete">删除</a><br />
									<a href="#none" >移到我的关注</a>
								</li>
							</ul>
						</div>
						{/foreach}
					</div>
				</div>
			</div>
			<div class="cart-tool">
				<div class="select-all">
					<input type="checkbox" class="check_all" name="" value="" />
					<span>全选</span>
				</div>
				<div class="option">
					<a href="#none">删除选中的商品</a>
					<a href="#none">移到我的关注</a>
					<a href="#none">清除下柜商品</a>
				</div>
				<div class="money-box">
					<div class="chosed">已选择<span id="total_number">0</span>件商品</div>
					<div class="sumprice">
						<span><em>总价（不含运费） ：</em><i id="total_price" class="summoney">¥0</i></span>
						<span><em>已节省：</em><i>-¥0</i></span>
					</div>
					<div class="sumbtn">
						<a class="sum-btn" href="javascript:;">结算</a>
					</div>
				</div>
			</div>
			<div class="clearfix"></div>
			<div class="deled">
				<span>已删除商品，您可以重新购买或加关注：</span>
				<div class="cart-list del">
					<ul class="goods-list yui3-g">
						<li class="yui3-u-1-2">
							<div class="good-item">
								<div class="item-msg">Apple Macbook Air 13.3英寸笔记本电脑 银色（Corei5）处理器/8GB内存</div>
							</div>
						</li>
						<li class="yui3-u-1-6"><span class="price">8848.00</span></li>
						<li class="yui3-u-1-6">
							<span class="number">1</span>
						</li>
						<li class="yui3-u-1-8">
							<a href="#none">重新购买</a>
							<a href="#none">移到我的关注</a>
						</li>
					</ul>
				</div>
			</div>
			<div class="liked">
				<ul class="sui-nav nav-tabs">
					<li class="active">
						<a href="#index" data-toggle="tab">猜你喜欢</a>
					</li>
					<li>
						<a href="#profile" data-toggle="tab">特惠换购</a>
					</li>
				</ul>
				<div class="clearfix"></div>
				<div class="tab-content">
					<div id="index" class="tab-pane active">
						<div id="myCarousel" data-ride="carousel" data-interval="4000" class="sui-carousel slide">
							<div class="carousel-inner">
								<div class="active item">
									<ul>
										<li>
											<img src="/static/home/img/like1.png" />
											<div class="intro">
												<i>Apple苹果iPhone 6s (A1699)</i>
											</div>
											<div class="money">
												<span>$29.00</span>
											</div>
											<div class="incar">
												<a href="#" class="sui-btn btn-bordered btn-xlarge btn-default"><i class="car"></i><span class="cartxt">加入购物车</span></a>
											</div>
										</li>
										<li>
											<img src="/static/home/img/like2.png" />
											<div class="intro">
												<i>Apple苹果iPhone 6s (A1699)</i>
											</div>
											<div class="money">
												<span>$29.00</span>
											</div>
											<div class="incar">
												<a href="#" class="sui-btn btn-bordered btn-xlarge btn-default"><i class="car"></i><span class="cartxt">加入购物车</span></a>
											</div>
										</li>
										<li>
											<img src="/static/home/img/like3.png" />
											<div class="intro">
												<i>Apple苹果iPhone 6s (A1699)</i>
											</div>
											<div class="money">
												<span>$29.00</span>
											</div>
											<div class="incar">
												<a href="#" class="sui-btn btn-bordered btn-xlarge btn-default"><i class="car"></i><span class="cartxt">加入购物车</span></a>
											</div>
										</li>
										<li>
											<img src="/static/home/img/like4.png" />
											<div class="intro">
												<i>Apple苹果iPhone 6s (A1699)</i>
											</div>
											<div class="money">
												<span>$29.00</span>
											</div>
											<div class="incar">
												<a href="#" class="sui-btn btn-bordered btn-xlarge btn-default"><i class="car"></i><span class="cartxt">加入购物车</span></a>
											</div>
										</li>
									</ul>
								</div>
								<div class="item">
									<ul>
										<li>
											<img src="/static/home/img/like1.png" />
											<div class="intro">
												<i>Apple苹果iPhone 6s (A1699)</i>
											</div>
											<div class="money">
												<span>$29.00</span>
											</div>
											<div class="incar">
												<a href="#" class="sui-btn btn-bordered btn-xlarge btn-default"><i class="car"></i><span class="cartxt">加入购物车</span></a>
											</div>
										</li>
										<li>
											<img src="/static/home/img/like2.png" />
											<div class="intro">
												<i>Apple苹果iPhone 6s (A1699)</i>
											</div>
											<div class="money">
												<span>$29.00</span>
											</div>
											<div class="incar">
												<a href="#" class="sui-btn btn-bordered btn-xlarge btn-default"><i class="car"></i><span class="cartxt">加入购物车</span></a>
											</div>
										</li>
										<li>
											<img src="/static/home/img/like3.png" />
											<div class="intro">
												<i>Apple苹果iPhone 6s (A1699)</i>
											</div>
											<div class="money">
												<span>$29.00</span>
											</div>
											<div class="incar">
												<a href="#" class="sui-btn btn-bordered btn-xlarge btn-default"><i class="car"></i><span class="cartxt">加入购物车</span></a>
											</div>
										</li>
										<li>
											<img src="/static/home/img/like4.png" />
											<div class="intro">
												<i>Apple苹果iPhone 6s (A1699)</i>
											</div>
											<div class="money">
												<span>$29.00</span>
											</div>
											<div class="incar">
												<a href="#" class="sui-btn btn-bordered btn-xlarge btn-default"><i class="car"></i><span class="cartxt">加入购物车</span></a>
											</div>
										</li>
									</ul>
								</div>
							</div>
							<a href="#myCarousel" data-slide="prev" class="carousel-control left">‹</a>
							<a href="#myCarousel" data-slide="next" class="carousel-control right">›</a>
						</div>
					</div>
					<div id="profile" class="tab-pane">
						<p>特惠选购</p>
					</div>
				</div>
			</div>
		</div>
	</div>
<script type="text/javascript">
	//定义页面加载事件
	$(function(){
		//封装一个重新计算已选商品数量和金额的函数
		var changetotal = function(){
			//获取到所有选中的行checkbox
			var checked = $('.row_check:checked');
			var total_number = 0;
			var total_price = 0;
			//for循环
			// for(var i = 0; i < checked.length; i++){
			// 	 // checked[i]  DOM对象
			// 	total_number += parseInt( $(checked[i]).closest('ul').find('.current_number').val() );
			// 	total_price += parseFloat( $(checked[i]).closest('ul').find('.sum').html() );
			// }
			//jquery中 $.each(要遍历的变量,)方法 用于数组|对象的遍历
			$.each(checked, function(i, v){
				// console.log(i);// i 是索引，从0 开始计数
				// console.log(v); // v 是遍历出来的值，是一个DOM对象
				//累加选中的数量
				total_number += parseInt( $(v).closest('ul').find('.current_number').val() );
				//累加小计金额
				total_price += parseFloat( $(v).closest('ul').find('.sum').html());
			});
			// console.log(total_number);
			// console.log(total_price);
			//将计算的值 修改到页面
			$('#total_number').html(total_number);
			$('#total_price').html(total_price);

		}

		//封装一个函数，发送ajax请求，修改购买数量
		var changenum = function(number, element){
			//组装请求参数
			var data = {
				"goods_id":$(element).closest("ul").attr('goods_id'),
				"goods_attr_ids":$(element).closest("ul").attr('goods_attr_ids'),
				"number":number
			};
			//发送请求
			$.ajax({
				"url":"{:url('changenum')}",
				"type":"post",
				"data":data,
				"dataType":"json",
				"success":function(res){
					if(res.code != 10000){
						alert(res.msg);return;
					}else{
						//修改成功
						//将新的数量显示到页面，当前行的input中
						$(element).closest('ul').find('.current_number').val(number);
						//计算当前行小计金额
						// 取当前行的单价
						var price = parseFloat( $(element).closest('ul').find('.price').html() );
						// var price = $(this).closest('ul').find('.price').text();
						//重新计算小计金额
						var sum = price * number;
						//将新的小计金额 +*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-+*-8
						$(element).closest('ul').find('.sum').html(sum);
						//将当前行ul上记录的旧的购买数量进行修改
						$(element).closest('ul').attr('number', number);
						//调用changetotal函数重新计算已选商品数量和价格
						changetotal();
					}
				}
			});
		};
		//给所有的 + 号 绑定点击事件
		$('.plus').click(function(){
			// 使用this 获取到触发事件的 + 号， 是一个DOM对象
			//获取 当前行 的input的value值
			var current_number = parseInt( $(this).prev().val() );
			// console.log( $(this).parent().children('.current_number') );
			// console.log( $(this).closest('ul').find('.current_number') );
			//计算新的数量  + 1
			var new_number = current_number + 1;
			//调用changenum函数发送ajax请求
			changenum(new_number, this);
		});

		//给所有的 - 号 绑定点击事件
		$('.mins').click(function(){
			// 使用this 获取到触发事件的 - 号， 是一个DOM对象
			//获取 当前行 的input的value值
			var current_number = parseInt( $(this).next().val() );
			//计算新的数量  - 1
			if(current_number == 1) return;
			var new_number = current_number - 1;
			//调用changenum函数发送ajax请求
			changenum(new_number, this);
		});

		//给所有的数量input 绑定change事件
		$('.current_number').change(function(){
			//获取到input中的值
			var new_number = parseInt( $(this).val() );
			//将修改之前的数量取出来，用于报错提示后，恢复
			var old_number = $(this).closest('ul').attr('number');
			//判断数据格式
			if(isNaN(new_number)){
				alert('购买数量必须是数字');
				$(this).val(old_number);
				return;
			}
			if(new_number < 1){
				alert('购买数量至少为1');
				$(this).val(old_number);
				return;
			}
			//调用changenum函数发送ajax请求
			changenum(new_number, this);
		});

		//给全选 绑定change事件
		$('.check_all').change(function(){
			//获取到全选的 选中状态  checked属性 使用prop方法才能获取
			// var status = $(this).attr('checked');
			var status = $(this).prop('checked');
			//给每一行的checkbox设置 checked属性值，status
			$('.row_check').prop('checked', status);
			//调用changetotal函数重新计算已选商品数量和价格
			changetotal();
		});

		//给每一行的checkbox 绑定change事件
		$('.row_check').change(function(){
			//获取所有的行的checkbox
			var all = $('.row_check');
			//获取选中的行的checkbox
			var checked = $('.row_check:checked');
			//判断 数量是否相等
			var status = all.length == checked.length;
			//将全选 checkbox的 选中状态 checked属性值 设置为status
			$('.check_all').prop('checked', status);
			//调用changetotal函数重新计算已选商品数量和价格
			changetotal();
		});

		//给删除绑定点击事件
		$('.delete').click(function(){
			//发送ajax请求 删除购物记录
			//组装请求参数
			var data = {
				'goods_id':$(this).closest('ul').attr('goods_id'),
				'goods_attr_ids':$(this).closest('ul').attr('goods_attr_ids')
			};
			var _this = this;
			//发送请求
			$.ajax({
				"url":"{:url('delcart')}",
				"type":"post",
				"data":data,
				"dataType":"json",
				"success":function(res){
					if(res.code != 10000){
						alert(res.msg);return;
					}else{
						//删除成功后的处理
						//将当前行记录从页面移除显示
						$(_this).closest('ul').parent().remove();
//						$(_this).closest('.cart-list').remove();
						//调用changetotal函数重新计算已选商品数量和价格
						changetotal();
					}
				}
			});
		});

		//给结算绑定点击事件
		$('.sum-btn').click(function(){
			//获取到所有选中的行
			var checked_checkbox = $('.row_check:checked');
			if(checked_checkbox.length == 0){
				//没有选中的记录，不能结算
				return;
			}
			//取到每一行对应的购物车记录主键id值
			//将所有取到的主键id值拼接成个字符串格式参数
			var cart_ids = '';
			$.each(checked_checkbox, function(i, v){
				//v是一个checkbox，是一个DOM对象
				var cart_id = $(v).closest('ul').attr('cart_id');
				cart_ids += cart_id + ',';
			});
			//去除最后一个逗号
			cart_ids = cart_ids.slice(0, -1);
			//发送请求跳转页面
			var url = "{:url('home/order/create')}" + "?cart_ids=" + cart_ids;
			location.href = url;
//			location.href = "/home/order/create.html?cart_ids=" + cart_ids;
		});

	});
</script>